<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>NO3 / NO4 含二维码实时同步</title>
  <style>
    body { padding: 20px; font-family: sans-serif; }
  </style>
</head>
<body>

<!-- ================= NO3（主数据源） ================= -->
<div id="NO3"
     style="position: relative;height:84mm; width:79mm; border:1px solid #999;">

  <span id="hall"
        style="position:absolute; left:10mm; top:2mm; font-size:12px;"></span>

  <span id="name"
        style="position:absolute; left:10mm; top:9mm; font-size:12px;"></span>

  <span id="date"
        style="position:absolute; left:37mm; top:1mm; font-size:12px;"></span>

  <!-- 二维码图片 -->
  <img id="qrcode"
       style="position:absolute; left:5mm; top:38mm; width:25mm; height:25mm;"
       alt="二维码">

</div>

<hr>

<button onclick="setQRCode()">设置二维码</button>
<button onclick="changeText()">修改文字</button>

<!-- ================= JS ================= -->
<script>
  /* ========= 克隆并修复 ID ========= */
  function cloneTicket(templateId, newId, prefix) {
    const template = document.getElementById(templateId);
    const clone = template.cloneNode(true);

    clone.id = newId;

    clone.querySelectorAll('[id]').forEach(el => {
      el.id = prefix + '_' + el.id;
    });

    template.after(clone);
    return clone;
  }

  /* ========= 同步 text + img ========= */
  function syncContent(from, to, prefix) {
    from.querySelectorAll('[id]').forEach(srcEl => {
      const target = to.querySelector('#' + prefix + '_' + srcEl.id);
      if (!target) return;

      // img → 同步 src
      if (srcEl.tagName === 'IMG') {
        if (target.src !== srcEl.src) {
          target.src = srcEl.src;
        }
        return;
      }

      // 其他元素 → 同步 text
      if (target.textContent !== srcEl.textContent) {
        target.textContent = srcEl.textContent;
      }
    });
  }

  /* ========= 建立监听 ========= */
  function observeTicket(source, mirror, prefix) {
    syncContent(source, mirror, prefix);

    const observer = new MutationObserver(() => {
      syncContent(source, mirror, prefix);
    });

    observer.observe(source, {
      subtree: true,
      childList: true,
      characterData: true,
      attributes: true,
      attributeFilter: ['src']
    });

    return observer;
  }

  /* ========= 初始化 ========= */
  const no3 = document.getElementById('NO3');

  const no4 = cloneTicket('NO3', 'NO4', 'no4');
  no4.style.marginTop = '10mm';
  no4.style.transform = 'translate(5mm, 3mm)';

  observeTicket(no3, no4, 'no4');

  /* ========= 模拟业务 ========= */
  function setQRCode() {
    no3.querySelector('#qrcode').src =
      'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=HelloNO3';
  }

  function changeText() {
    no3.querySelector('#hall').textContent = '2号厅';
    no3.querySelector('#name').textContent = '实时同步测试';
  }
</script>

</body>
</html>
